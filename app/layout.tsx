import { AntdRegistry } from '@ant-design/nextjs-registry'
import type { Metadata } from 'next'
import './globals.css'

import { GET_STORE_CONFIG } from '@/graphql/queries/getStoreConfig'
import { getClient } from '@/lib/apollo/client'
import { getIntl } from '@/lib/i18n/intl'
import AntdThemeRegistry from '@/lib/antd/registry'
import StyledComponentsRegistry from '@/lib/styled/registry'
import ApolloRegistry from '@/lib/apollo/registry'
import StoreProviderRegistry from '@/lib/store/registry'
import ServerIntlProvider from '@/lib/i18n/registry'
import ProgressRegistry from '@/lib/progress/registry'
import Header from '@/components/Header'
import Footer from '@/components/Footer'

export const metadata: Metadata = {
  title: 'Adobe Headless',
  keywords: 'Adobe Headless',
  description: 'Generated by create ranger theme cli'
}

export const runtime = 'edge'

const fetchData = async () => {
  try {
    const { data } = await getClient().query({ query: GET_STORE_CONFIG })
    return data
  } catch (error) {
    console.info(error)
  }
}

const RootLayout = async ({
  children
}: Readonly<{
  children: React.ReactNode
}>) => {
  const data = await fetchData()
  const intl = await getIntl('en')

  return (
    <html>
      <body>
        <ApolloRegistry>
          <StoreProviderRegistry initState={data}>
            <ServerIntlProvider messages={intl.messages} locale={intl.locale}>
              <StyledComponentsRegistry>
                <AntdRegistry>
                  <AntdThemeRegistry>
                    <div id="next">
                      <ProgressRegistry />
                      <Header />
                      <main className="main-page-dhh max-w-screen-2xl mx-auto">{children}</main>
                      <Footer />
                    </div>
                  </AntdThemeRegistry>
                </AntdRegistry>
              </StyledComponentsRegistry>
            </ServerIntlProvider>
          </StoreProviderRegistry>
        </ApolloRegistry>
      </body>
    </html>
  )
}

export default RootLayout
